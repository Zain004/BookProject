<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
          rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6 form-container">
            <h1 class="form-title text-center mb-4">Register User</h1>
            <form onsubmit="handleSubmit(event)" class="user-register-form" novalidate>
                <!-- firstName -->
                <div class="mb-3">
                    <label for="firstname" class="form-label">Firstname </label>
                    <input
                            type="text"
                            id="firstname"
                            name="firstname"
                            class="form-control"
                            placeholder="write firstname"
                            title="firstname must be between 2 or 50 characters."
                            autofocus
                            required>
                    <div class="invalid-feedback">Firstname must be between 2 and 50 chacters.</div>
                </div>
                <!-- lastname -->
                <div class="mb-3">
                    <label for="lastname" class="form-label">Lastname </label>
                    <input
                            type="text"
                            id="lastname"
                            name="lastname"
                            title="Write lastname. must be between 2 to 50 characters."
                            placeholder="writ lastname"
                            class="form-control" required>
                    <div class="invalid-feedback">Lastname must be between 2 and 50 characters.</div>
                </div>
                <!-- Date of Birth -->
                <div class="mb-3">
                    <label for="dob" class="form-label">Date of Birth</label>
                    <input
                            type="date"
                            id="dob"
                            name="dob"
                            class="form-control"
                            required>
                    <div class="invalid-feedback">You must be at least 18 years old.</div>
                </div>
                <!-- Phone -->
                <div class="mb-3">
                    <label for="phone" class="form-label">Phone number : </label>
                    <input
                            type="tel"
                            id="phone"
                            name="phone"
                            placeholder="write 8 digits telephone"
                            title="telephone must be 8 digits"
                            class="form-control"
                            required>
                    <div class="invalid-feedback">Phone number must be 8 digits</div>
                </div>
                <!-- email -->
                <div class="mb-3">
                    <label for="email" class="form-label">Email: </label>
                    <input
                            type="email"
                            id="email"
                            name="email"
                            title="email must be in format example@xxx.com"
                            placeholder="email must be in format example@xxx.com"
                            class="form-control"
                            required>
                    <div class="invalid-feedback">Please enter a valid email address.</div>
                </div>
                <button type="submit" class="btn btn-success" >Register</button>
            </form>
        </div>
    </div>
</div>
<!-- Bruker en toast for å vise feilmeldinger-->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="toastMessage" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">Notification</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="close"></button>
        </div>
        <div class="toast-body"></div>
    </div>
</div>
<!-- Bootstrap JS Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>

    const validateField = (value, regex, inputElement) => {
        if(!regex.test(value)) {
            inputElement.classList.add('is-invalid');
            return false;
        }
        inputElement.classList.remove('is-invalid');
        inputElement.classList.add('is-valid');
        return true;
    };
    const validateFirstname = () => {
        const firstName = document.getElementById('firstname');
        return validateField(
            firstName.value,
            /^(?!\s)(?!.*\s{2})[A-Za-z.\- ]{2,50}(?<!\s)$/,
            firstName
        );
    };
    const validateLastname = () => {
        const lastname = document.getElementById('lastname');
        return validateField(
            lastname.value,
            /^(?!\s)(?!.*\s{2})[A-Za-z.\- ]{2,50}(?<!\s)$/,
            lastname
        );
    };
    const validateDob = () => {
        const dobInput = document.getElementById('dob'); // Hent input-feltet
        const invalidFeedback = dobInput.nextElementSibling; // hent tilknyttet neste element som er invalid-feedback
        const dobValue = dobInput.value; // Hent verdien direkte fra input-feltet
        // sjekk om datoen er tom
        if(!dobValue) {
            dobInput.classList.add("is-invalid");
            invalidFeedback.textContent = "Please enter your date of Birth";
            return false;
        }
        const dob = new Date(dobValue); // lag et nytt Date objekt
        const today = new Date(); // finn dagens dato
        let age = today.getFullYear() - dob.getFullYear(); // beregn
        const monthDifference = today.getMonth() - dob.getMonth();

        if(monthDifference < 0 || (monthDifference === 0 && today.getDate() < dob.getDate())) {
            age--;
        }
        // Sjekk om brukeren er minst 18 år
        if(age < 18) {
            dobInput.classList.add('is-invalid'); // legg til feilmeldingen
            invalidFeedback.textContent = "You must be at least 18 years old.";
            return false;
        }
        // fjern is-invalid og legg til is-valid (grønn kant)
        dobInput.classList.remove('is-invalid');
        dobInput.classList.add('is-valid'); // legg til is-valid (grønn-kant)
        return true;
    };
    const validatePhone = () => {
        const phone = document.getElementById('phone');
        return validateField(
            phone.value,
            /^(?!\s)[0-9]{8}(?<!\s)$/,
            phone
        );
    };
    const validateEmail = () => {
        const email = document.getElementById('email');
        return validateField(
            email.value,
            /^[A-Za-z0-9._%+/-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$/,
            email
        );
    };
    const showToast = (message, isSuccess = true) => {
        const toastElement = document.getElementById('toastMessage');
        const toastBody = toastElement.querySelector('.toast-body');
        toastElement.classList.remove('bg-danger', 'bg-success'); // først fjerner den eventuelle bakgrunnsfarger
        toastElement.classList.add(isSuccess ? 'bg-success' : 'bg-danger'); // så legegr den til ny fagre
        toastBody.textContent = message // deretter definerer den meldingstekst
        const toast = new bootstrap.Toast(toastElement);
        toast.show();
    }

    const handleSubmit = async (event) => {
        event.preventDefault();
        const firstname = document.getElementById('firstname').value.trim();
        const lastName = document.getElementById('lastname').value.trim();
        const dob = document.getElementById('dob').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const email = document.getElementById('email').value.trim();
        const user = {
            firstName: firstname,
            lastName: lastName,
            dob: dob,
            phone: phone,
            email: email
        }
        if ( !validateFirstname() || !validateLastname() ||
            !validateDob() || !validatePhone() || !validateEmail()) {
            showToast("Please fill in all fields correctly.", false)
            return
        }
        try {
            const response = await registerUser(user);
            console.info(user);
            console.info(`${response.success}`);
            resetFormInputs();
            showToast("Registration succssfull", true)
        } catch (error) {
            console.error("Registration failed:", error)
            showToast(`${error.message}` || "Something went wrong!", false);
        }
    }

    const registerUser = async (data) => {
        const response = await axios.post("/usersController/saveUser", data);
        return response.data;
    }
    const forms = Array.from(document.querySelectorAll('.user-register-form'));
    const resetFormInputs = () => {
        forms.forEach((form) => {
            form.reset();
        });
    }
    document.addEventListener('DOMContentLoaded', () => {
        console.info("HTML-dokumentet er lastet og klart for manipulering");
    });
    // Liste over valideringsregler med korresporende ID
    const validations = {
        firstname: validateFirstname,
        lastname: validateLastname,
        dob: validateDob,
        phone: validatePhone,
        email: validateEmail
    };
    // Validere alle feltene med samme event listener
    forms.forEach(form => {
        form.addEventListener('input', (e) => {
            const fieldId = e.target.id; // hent inputfeltenes ID
            if(validations[fieldId]) { // kjør validasjonsfunkjsonen hvis det finnes
                e.preventDefault();
                e.stopPropagation();
                form.checkValidity(e);
                validations[fieldId](); // kall valideringsfunksjonen
                return true;
            }
            return false;
        })
    })
</script>
</body>
</html>